# Maintainer: Omarchy <pkgs@omarchy.org>
# Based on official Arch Linux hyprland package
# Modified for ARM with GCC 14 compatibility patches

pkgname=hyprland
pkgver=0.51.1
pkgrel=2
pkgdesc='A highly customizable dynamic tiling Wayland compositor (ARM with GCC 14 patches)'
arch=('aarch64')
url='https://github.com/hyprwm/Hyprland'
license=('BSD-3-Clause')
depends=(
  aquamarine
  cairo
  gcc-libs
  glib2
  glslang
  hyprcursor
  hyprgraphics
  hyprlang
  hyprutils
  libdisplay-info
  libdrm
  libglvnd
  libinput
  libliftoff
  libx11
  libxcb
  libxcomposite
  libxcursor
  libxfixes
  libxkbcommon
  libxrender
  mesa
  pango
  pixman
  re2
  seatd
  systemd-libs
  tomlplusplus
  wayland
  wayland-protocols
  xcb-proto
  xcb-util
  xcb-util-errors
  xcb-util-keysyms
  xcb-util-renderutil
  xcb-util-wm
  xorg-xwayland
)
makedepends=(
  cmake
  meson
  ninja
  glaze
  hyprland-protocols
  vulkan-headers
  xorgproto
)
source=(
  "https://github.com/hyprwm/Hyprland/releases/download/v${pkgver}/source-v${pkgver}.tar.gz"
)
sha256sums=(
  'f562b8d1efc9934abd9678e3a4d7bb5a56adc6ef89c4679aba269de470e66131'
)

prepare() {
  cd "hyprland-source"

  # Apply Arch Linux build modifications
  msg2 "Applying Arch Linux build configuration..."

  # Add CMAKE_SKIP_RPATH=ON to release target (matches Arch PKGBUILD)
  sed -i -e '/^release:/{n;s/-D/-DCMAKE_SKIP_RPATH=ON -D/}' Makefile

  # Remove version script (workaround for Arch Linux issue #15)
  rm -fv scripts/generateVersion.sh

  # Apply GCC 14 compatibility patch (#embed requires GCC 15+)
  msg2 "Applying GCC 14 compatibility patch for #embed directive..."

  if [[ ! -f "example/hyprland.conf" ]]; then
    error "example/hyprland.conf not found"
    return 1
  fi

  # Generate GCC 14 compatible defaultConfig.hpp
  cp src/config/defaultConfig.hpp src/config/defaultConfig.hpp.orig

  cat > src/config/defaultConfig.hpp << 'HEADER_EOF'
#pragma once

#include <string>

inline constexpr std::string_view AUTOGENERATED_PREFIX   = R"#(
# #######################################################################################
# AUTOGENERATED HYPRLAND CONFIG.
# EDIT THIS CONFIG ACCORDING TO THE WIKI INSTRUCTIONS.
# #######################################################################################

autogenerated = 1 # remove this line to remove the warning

)#";

// GCC 14 compatibility: Replaced #embed with inline string
// #embed requires GCC 15+ (C++26 feature not available in GCC 14.2.1 on ARM)
// This approach matches Hyprland 0.49.0 methodology
inline const std::string EXAMPLE_CONFIG = R"#(
HEADER_EOF

  # Append the config content
  cat example/hyprland.conf >> src/config/defaultConfig.hpp

  # Close the raw string literal
  cat >> src/config/defaultConfig.hpp << 'FOOTER_EOF'
)#";
FOOTER_EOF

  msg2 "Applying GCC 14 compatibility fixes for string concatenation and C++23 APIs..."

  # Fix string concatenation template deduction in hyprctl/main.cpp
  cp hyprctl/main.cpp hyprctl/main.cpp.orig

  # Fix pattern 1: getRuntimeDir() + "/" + instanceSignature + "/.socket.sock"
  sed -i 's|std::string socketPath = getRuntimeDir() + "/" + instanceSignature + "/.socket.sock";|std::string socketPath = getRuntimeDir();\n    socketPath += "/";\n    socketPath += instanceSignature;\n    socketPath += "/.socket.sock";|' hyprctl/main.cpp

  # Fix pattern 2: getRuntimeDir() + "/" + instanceSignature + "/" + filename
  sed -i 's|std::string socketPath = getRuntimeDir() + "/" + instanceSignature + "/" + filename;|std::string socketPath = getRuntimeDir();\n        socketPath += "/";\n        socketPath += instanceSignature;\n        socketPath += "/";\n        socketPath += filename;|' hyprctl/main.cpp

  # Fix pattern 3: fullRequest = fullArgs + "/" + fullRequest
  sed -i 's|fullRequest          = fullArgs + "/" + fullRequest;|fullArgs += "/";\n        fullArgs += fullRequest;\n        fullRequest = fullArgs;|' hyprctl/main.cpp

  # Fix ternary operator type deduction in src/xwayland/XWM.hpp
  cp src/xwayland/XWM.hpp src/xwayland/XWM.hpp.orig
  sed -i 's|return m_connection ? \*m_connection : nullptr;|return m_connection ? *m_connection : static_cast<xcb_connection_t*>(nullptr);|' src/xwayland/XWM.hpp

  # Fix C++23 insert_range in src/helpers/Monitor.cpp
  cp src/helpers/Monitor.cpp src/helpers/Monitor.cpp.orig
  sed -i 's#requestedModes\.insert_range(requestedModes\.end(), sortedModes | std::views::reverse);#std::ranges::copy(sortedModes | std::views::reverse, std::back_inserter(requestedModes));#' src/helpers/Monitor.cpp

  msg2 "GCC 14 compatibility patches applied"
}

build() {
  cd "hyprland-source"
  make release PREFIX=/usr
}

package() {
  cd "hyprland-source"
  make install PREFIX=/usr DESTDIR="$pkgdir"

  # License
  install -Dm644 LICENSE -t "$pkgdir/usr/share/licenses/$pkgname/"
}
